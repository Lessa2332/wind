<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="utf-8">
    <title>–í—ñ—Ç–µ—Ä! –î–º–∏ –∞–±–æ –≤–∏–π–¥–∏ –Ω–∞ –≤—É–ª–∏—Ü—é üå¨Ô∏è</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        #video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; transform: scaleX(-1); }
        #canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #start { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px 40px; font-size: 28px; background: #4CAF50; color: white; border: none; border-radius: 20px; z-index: 10; cursor: pointer; }
        #info { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 15px; text-align: center; font-size: 18px; z-index: 10; display: none; }
        #realWind { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,100,255,0.8); color: white; padding: 15px; border-radius: 15px; text-align: center; font-size: 20px; z-index: 10; display: none; animation: pulse 1s infinite; }
        #scale { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 80%; height: 30px; background: gray; border-radius: 15px; overflow: hidden; z-index: 10; display: none; }
        #bar { height: 100%; width: 0%; transition: width 0.5s ease, background 0.5s ease; }
        @keyframes pulse { 0% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.1); } 100% { transform: translateX(-50%) scale(1); } }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
</head>
<body>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    <button id="start">üå¨Ô∏è –ü–æ—á–∞—Ç–∏! –î–º–∏ –∞–±–æ –≤–∏–π–¥–∏ –Ω–∞ –≤—É–ª–∏—Ü—é</button>
    <div id="info">–î–º–∏ –≤ –º—ñ–∫—Ä–æ—Ñ–æ–Ω –∞–±–æ —Ç—Ä–∏–º–∞–π —Ç–µ–ª–µ—Ñ–æ–Ω –ø—Ä–æ—Ç–∏ –≤—ñ—Ç—Ä—É!<br>–ó–µ–ª–µ–Ω–∏–π ‚Äî —Å–ª–∞–±–∫–∏–π, –ß–µ—Ä–≤–æ–Ω–∏–π ‚Äî —Å–∏–ª—å–Ω–∏–π!</div>
    <div id="realWind">–û–≥–æ! –¶–µ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –≤—ñ—Ç–µ—Ä –Ω–∞ –≤—É–ª–∏—Ü—ñ! üå¨Ô∏èüí®</div>
    <div id="scale"><div id="bar"></div></div>

    <script>
        let video, scene, camera, renderer, particles, windForce = 0;
        let audioContext, analyser, microphone, lowpassFilter;
        const startBtn = document.getElementById('start');
        const info = document.getElementById('info');
        const realWind = document.getElementById('realWind');
        const scale = document.getElementById('scale');
        const bar = document.getElementById('bar');

        startBtn.onclick = async () => {
            startBtn.style.display = 'none';
            info.style.display = 'block';
            scale.style.display = 'block';

            // –ö–∞–º–µ—Ä–∞ (–∑–∞–¥–Ω—è –¥–ª—è –≤—É–ª–∏—Ü—ñ)
            video = document.getElementById('video');
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' }, 
                audio: { 
                    echoCancellation: false,     // –í–∏–º–∏–∫–∞—î–º–æ, —â–æ–± –≤—ñ—Ç–µ—Ä –∫—Ä–∞—â–µ –ø—Ä–æ—Ö–æ–¥–∏–≤
                    noiseSuppression: false,     // –ù–µ –ø—Ä–∏–¥—É—à—É—î–º–æ —à—É–º –≤—ñ—Ç—Ä—É
                    autoGainControl: false 
                } 
            });
            video.srcObject = stream;
            video.play();

            // Three.js
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            // –ß–∞—Å—Ç–∏–Ω–∫–∏ –≤—ñ—Ç—Ä—É
            const particleCount = 600;
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            const sizes = new Float32Array(particleCount);

            for (let i = 0; i < particleCount; i++) {
                positions[i*3] = (Math.random() - 0.5) * 15;
                positions[i*3+1] = (Math.random() - 0.5) * 15;
                positions[i*3+2] = (Math.random() - 0.5) * 10;
                sizes[i] = Math.random() * 0.3 + 0.15;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            const material = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.2,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            // Audio
            audioContext = new AudioContext();
            microphone = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 1024;  // –ë—ñ–ª—å—à–∏–π –¥–ª—è –∫—Ä–∞—â–æ–≥–æ —á–∞—Å—Ç–æ—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É

            // Low-pass —Ñ—ñ–ª—å—Ç—Ä: –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –Ω–∏–∑—å–∫—ñ —á–∞—Å—Ç–æ—Ç–∏ –≤—ñ—Ç—Ä—É (<500 Hz)
            lowpassFilter = audioContext.createBiquadFilter();
            lowpassFilter.type = 'lowpass';
            lowpassFilter.frequency.value = 500;  // –†—ñ–∂–µ–º–æ –≤–∏—Å–æ–∫—ñ —á–∞—Å—Ç–æ—Ç–∏ (–≥–æ–ª–æ—Å, –∫–ª–∞—Ü–∞–Ω–Ω—è)
            lowpassFilter.Q.value = 1;

            microphone.connect(lowpassFilter);
            lowpassFilter.connect(analyser);

            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            function updateWind() {
                analyser.getByteFrequencyData(dataArray);

                // –ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å —É –Ω–∏–∑—å–∫–∏—Ö —á–∞—Å—Ç–æ—Ç–∞—Ö (0-500 Hz ‚âà –ø–µ—Ä—à—ñ ~100 –±—ñ–Ω—ñ–≤ –ø—Ä–∏ 1024 fft)
                let lowPower = 0;
                for (let i = 0; i < 100; i++) {
                    lowPower += dataArray[i];
                }
                lowPower /= 100;

                // –ó–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è + —á—É—Ç–ª–∏–≤—ñ—Å—Ç—å
                windForce = windForce * 0.8 + (lowPower / 255) * 0.2 * 4;  // –ó–±—ñ–ª—å—à–µ–Ω–∞ —á—É—Ç–ª–∏–≤—ñ—Å—Ç—å
                windForce = Math.max(0, Math.min(1, windForce));

                // –®–∫–∞–ª–∞ —Ç–∞ –∫–æ–ª—ñ—Ä
                bar.style.width = (windForce * 100) + '%';
                if (windForce < 0.3) bar.style.background = 'green';
                else if (windForce < 0.6) bar.style.background = 'yellow';
                else bar.style.background = 'red';

                // –ü–æ–∫–∞–∑ "—Å–ø—Ä–∞–≤–∂–Ω—ñ–π –≤—ñ—Ç–µ—Ä" —è–∫—â–æ —Å–∏–ª–∞ —Å–µ—Ä–µ–¥–Ω—è —ñ —Å—Ç–∞–±—ñ–ª—å–Ω–∞
                if (windForce > 0.25) {
                    realWind.style.display = 'block';
                } else {
                    realWind.style.display = 'none';
                }

                // –†—É—Ö —á–∞—Å—Ç–∏–Ω–æ–∫
                const positions = particles.geometry.attributes.position.array;
                for (let i = 0; i < particleCount; i++) {
                    positions[i*3 + 2] += windForce * 0.15;  // –®–≤–∏–¥—à–µ –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º—É –≤—ñ—Ç—Ä—ñ
                    if (positions[i*3 + 2] > 8) {
                        positions[i*3 + 2] = -8;
                        positions[i*3] = (Math.random() - 0.5) * 15;
                        positions[i*3 + 1] = (Math.random() - 0.5) * 15;
                    }
                }
                particles.geometry.attributes.position.needsUpdate = true;

                requestAnimationFrame(updateWind);
            }
            updateWind();

            animate();
        };

        function animate() {
            requestAnimationFrame(animate);
            particles.rotation.y += 0.001 * (1 + windForce);
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
